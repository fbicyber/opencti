import 'chromedriver';
import { By } from 'selenium-webdriver';
import DriverService from './common/driver_service';
import {
  wait,
  getXpathNodeWith,
  getElementWithTimeout,
} from './common/action_service';
import {
  addMalwareAnalysesReport,
  navigateToMalwareAnalysesReport,
  selectMalwareAnalysesReport,
  editMalwareAnalysesReport,
} from './common/malware_analyses_service';
import { deleteDomainObject } from './common/domain_object_service';
import { logIn_LocalStrategy } from './common/auth_service';

describe('Malware Analyses Workflow', () => {
  const PRODUCT = 'Test Malware Analyses Product Field - Product';
  const REPORT = 'Test Malware Report Name Field - Report';
  const UPDATED_PRODUCT = 'UPDATED Malware Analyses Product Field - Product';
  const UPDATED_REPORT = 'UPDATED Malware Report Name Field - Report';

  beforeAll(async () => {
    await logIn_LocalStrategy();
    await wait(); // Wait for login
  });

  afterAll(async () => {
    await DriverService.teardownDriver();
  });

  test('create a malware analysis report', async () => {
    await navigateToMalwareAnalysesReport();
    await addMalwareAnalysesReport(PRODUCT, REPORT);
    await wait(5000);
    await selectMalwareAnalysesReport(PRODUCT);

    // Check that the product field is correct
    const productField = await getXpathNodeWith('text', PRODUCT);
    const actualProduct = await productField.getText();
    expect(actualProduct).toBe(PRODUCT);

    // Check that the report field is correct
    const reportField = await getXpathNodeWith('text', REPORT);
    const actualReport = await reportField.getText();
    expect(actualReport).toBe(REPORT);
  });

  test('view a malware analysis report', async () => {
    await navigateToMalwareAnalysesReport();
    await selectMalwareAnalysesReport(PRODUCT);
    await wait(5000);
    // Check that the product field is correct
    const productField = await getXpathNodeWith('text', PRODUCT);
    const actualProduct = await productField.getText();
    expect(actualProduct).toBe(PRODUCT);

    // Check that the report field is correct
    const reportField = await getXpathNodeWith('text', REPORT);
    const actualReport = await reportField.getText();
    expect(actualReport).toBe(REPORT);
  });

  test('edit a malware analysis report', async () => {
    await navigateToMalwareAnalysesReport();
    await wait(1000);
    await selectMalwareAnalysesReport(PRODUCT);
    await wait(3000);
    await editMalwareAnalysesReport(UPDATED_PRODUCT, UPDATED_REPORT);
    await wait(1000);
    await selectMalwareAnalysesReport(UPDATED_PRODUCT);
    await wait(3000);
    // Check that the product field is updated correctly
    const newNameField = await getXpathNodeWith('text', UPDATED_PRODUCT);
    const newActualName = await newNameField.getText();
    expect(newActualName).toBe(UPDATED_PRODUCT);

    // Check that the report field is correct
    const reportField = await getXpathNodeWith('text', UPDATED_REPORT);
    const actualReport = await reportField.getText();
    expect(actualReport).toBe(UPDATED_REPORT);
  });

  test('delete a malware analysis report', async () => {
    await navigateToMalwareAnalysesReport();
    await selectMalwareAnalysesReport(UPDATED_PRODUCT);
    await wait(3000);
    await deleteDomainObject();
    await wait(5000);

    // Check Case Malware Analyses report no longer shows up
    const t = async () => {
      await getElementWithTimeout(
        By.xpath(`//*[text()="${UPDATED_PRODUCT}"]/ancestor::a`),
        2000,
      );
    };
    // RxJS instanceof TimeoutError expects TimeoutErrorImpl for some reason
    // await expect(t).rejects.toThrow(TimeoutError);
    await expect(t).rejects.toThrow();
  });
});
